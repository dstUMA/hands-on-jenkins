#!/usr/bin/groovy

pipeline {
    agent any

    options {
        disableConcurrentBuilds()
    }

    environment {
        DOCKER_IMAGE = "hands-on-jenkins/myapp:${BUILD_NUMBER}"
        DOCKER_HOST = 'npipe:////./pipe/docker_engine'  # Para Windows
    }

    stages {
        stage('Check Docker') {
            steps {
                bat 'docker --version'
                bat 'docker info'
            }
        }
        
        stage("Build") {
            steps {
                script {
                    dir('section_4/code/cd_pipeline') {
                        // Primero verifica que el Dockerfile existe
                        bat 'dir'
                        bat 'type Dockerfile || echo "No Dockerfile found"'
                        
                        // Construye la imagen
                        bat "docker build --no-cache -t ${DOCKER_IMAGE} ."
                    }
                }
            }
        }

        stage("Test Image") {
            steps {
                script {
                    bat "docker images | findstr \"${DOCKER_IMAGE}\""
                }
            }
        }

        stage("Deploy - Dev") {
            steps {
                script {
                    deploy('dev')
                }
            }
        }
    }
}

def deploy(environment) {
    def containerName = 'app_dev'
    def port = '8888'
    
    if (environment != 'dev') {
        error("Environment not valid: ${environment}")
    }

    script {
        // Detener y eliminar contenedor si existe
        bat """
            @echo off
            docker stop ${containerName} 2>nul && echo Stopped container || echo No container to stop
            docker rm ${containerName} 2>nul && echo Removed container || echo No container to remove
        """
        
        // Ejecutar nuevo contenedor
        bat "docker run -d -p ${port}:5000 --name ${containerName} ${DOCKER_IMAGE}"
        
        // Verificar que est√° corriendo
        bat "docker ps | findstr \"${containerName}\""
    }
}